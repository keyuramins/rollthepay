# PgBouncer Configuration for RollThePay
# High-performance connection pooling for PostgreSQL

# ===========================================
# Database Configuration
# ===========================================

[databases]
# Main RollThePay database
rollthepay = host=localhost port=5432 dbname=rollthepay user=postgres password=your_password

# ===========================================
# PgBouncer Configuration
# ===========================================

[pgbouncer]
# Network settings
listen_addr = *
listen_port = 6432
listen_backlog = 128

# Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# Pool settings
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 20
min_pool_size = 5
reserve_pool_size = 5
reserve_pool_timeout = 3

# Connection limits
max_db_connections = 100
max_user_connections = 100

# Timeouts
server_connect_timeout = 15
server_login_retry = 15
query_timeout = 0
query_wait_timeout = 120
client_idle_timeout = 0
client_login_timeout = 60
autodb_idle_timeout = 3600

# Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60

# Security
ignore_startup_parameters = extra_float_digits

# Performance
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 600
tcp_keepintvl = 30

# ===========================================
# RollThePay Specific Settings
# ===========================================

# Use transaction-level pooling for better performance
# This allows connection reuse within transactions
pool_mode = transaction

# Optimize for read-heavy workload
# Higher pool size for better concurrency
default_pool_size = 20

# Reserve connections for high-priority operations
reserve_pool_size = 5
reserve_pool_timeout = 3

# ===========================================
# Monitoring and Statistics
# ===========================================

# Enable detailed logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

# Statistics collection
log_stats = 1
stats_period = 60

# ===========================================
# Security Configuration
# ===========================================

# Use MD5 authentication (more secure than plain text)
auth_type = md5

# Ignore startup parameters that might cause issues
ignore_startup_parameters = extra_float_digits

# ===========================================
# High Availability Settings
# ===========================================

# Connection retry settings
server_connect_timeout = 15
server_login_retry = 15

# Client timeout settings
client_login_timeout = 60
client_idle_timeout = 0

# ===========================================
# Performance Tuning
# ===========================================

# TCP keepalive settings
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 600
tcp_keepintvl = 30

# Query timeout (0 = no timeout)
query_timeout = 0
query_wait_timeout = 120

# ===========================================
# Configuration Notes
# ===========================================

# 1. Pool Mode Options:
#    - session: One connection per client session
#    - transaction: One connection per transaction (recommended)
#    - statement: One connection per statement (not recommended for RollThePay)

# 2. Connection Limits:
#    - max_client_conn: Maximum client connections to PgBouncer
#    - default_pool_size: Default connections per database
#    - max_db_connections: Maximum connections to PostgreSQL per database
#    - max_user_connections: Maximum connections per user

# 3. Timeout Settings:
#    - server_connect_timeout: Time to wait for PostgreSQL connection
#    - client_login_timeout: Time to wait for client authentication
#    - query_timeout: Maximum query execution time (0 = no limit)
#    - client_idle_timeout: Time before closing idle client connections

# 4. For Production:
#    - Use auth_type = md5 or scram-sha-256
#    - Set appropriate pool sizes based on load
#    - Enable logging for monitoring
#    - Use reserve pools for critical operations

# 5. For Development:
#    - Reduce pool sizes to save resources
#    - Use auth_type = trust (less secure)
#    - Disable detailed logging

# ===========================================
# User List File (userlist.txt)
# ===========================================

# Create /etc/pgbouncer/userlist.txt with:
# "postgres" "md5<hashed_password>"
# 
# To generate MD5 hash:
# echo -n "passwordpostgres" | md5sum
# 
# Example:
# "postgres" "md5a8f5f167f44f4964e6c998dee827110c"

# ===========================================
# Systemd Service Configuration
# ===========================================

# Create /etc/systemd/system/pgbouncer.service:
# [Unit]
# Description=PostgreSQL connection pooler
# After=postgresql.service
# 
# [Service]
# Type=forking
# User=postgres
# ExecStart=/usr/bin/pgbouncer -d /etc/pgbouncer/pgbouncer.ini
# ExecReload=/bin/kill -HUP $MAINPID
# PIDFile=/var/run/pgbouncer/pgbouncer.pid
# 
# [Install]
# WantedBy=multi-user.target

# ===========================================
# Monitoring Commands
# ===========================================

# Check PgBouncer status:
# pgbouncer -c "SHOW STATS;"

# Check active connections:
# pgbouncer -c "SHOW POOLS;"

# Check client connections:
# pgbouncer -c "SHOW CLIENTS;"

# Check server connections:
# pgbouncer -c "SHOW SERVERS;"

# Reload configuration:
# pgbouncer -c "RELOAD;"
